# Version 2.6.39 - Bug Fixes

**Date:** 2025-01-XX
**Status:** Ready for deployment
**Testing Results from v2.6.38:** ‚úÖ Add Card images working, ‚úÖ Edit card shows back working

## Issues Fixed

### 1. ‚úÖ manifest.json 404 Errors (FIXED)

**Symptom:** Console showing repeated 404 errors for manifest.json  
**Root Cause:** Backend only served static files from `/static/*` prefix, not root-level files like `/manifest.json`  
**Solution:** Added dedicated route in `backend/app/main.py` to serve manifest.json from root path

**Files Changed:**
- `backend/app/main.py` (lines ~215)

**Code Added:**
```python
# Serve manifest.json from root path
@app.get("/manifest.json")
async def serve_manifest():
    """Serve manifest.json from frontend directory for PWA support"""
    from fastapi.responses import FileResponse
    manifest_path = os.path.join(frontend_path, "manifest.json")
    if os.path.exists(manifest_path):
        return FileResponse(manifest_path, media_type="application/json")
    else:
        raise HTTPException(status_code=404, detail="manifest.json not found")
```

**Testing:**
- Navigate to https://learn.rentyourcio.com/manifest.json
- Verify returns JSON (not 404)
- Check browser console - no more manifest.json errors

---

### 2. ‚úÖ "Generate More Cards" File Input Not Responding (FIXED)

**Symptom:** After generating batch cards, clicking "Generate more cards" shows upload section but selecting file does nothing  
**Root Cause:** File input value not reset after first upload, so browser doesn't trigger change event on subsequent uploads  
**Solution:** Reset file input value in "Generate more cards" click handler

**Files Changed:**
- `frontend/app.js` (lines ~3936-3945)

**Code Modified:**
```javascript
document.getElementById('batch-another').onclick = () => {
    document.getElementById('batch-generation-results').classList.add('hidden');
    document.getElementById('parser-upload-section').classList.remove('hidden');
    
    // Reset file input to allow re-upload
    const fileInput = document.getElementById('document-file');
    if (fileInput) {
        fileInput.value = '';
        console.log('üîÑ File input reset for next upload');
    }
};
```

**Testing:**
1. Upload file, generate batch
2. Click "Generate more cards"
3. Select same or different file
4. Verify file parses and shows word list

---

### 3. ‚úÖ Language Change Doesn't Update Batch List (FIXED)

**Symptom:** After parsing text for batch generation, changing language selector doesn't clear or reprocess the parsed word list  
**Root Cause:** No event listener existed for batch import to respond to `languageChanged` events  
**Solution:** Added event listener to clear batch parsed results when language changes

**Files Changed:**
- `frontend/app.js` (lines ~3415-3432)

**Code Added:**
```javascript
// Clear batch import when language changes
document.addEventListener('languageChanged', () => {
    console.log('üåç Language changed - clearing batch import');
    
    // Clear parsed entries display
    const entriesContainer = document.getElementById('parsed-entries-container');
    if (entriesContainer) {
        entriesContainer.innerHTML = '';
    }
    
    // Hide results section, show upload section
    const resultsSection = document.getElementById('parser-results-section');
    const uploadSection = document.getElementById('parser-upload-section');
    if (resultsSection) resultsSection.classList.add('hidden');
    if (uploadSection) uploadSection.classList.remove('hidden');
    
    // Reset file input
    const fileInput = document.getElementById('document-file');
    if (fileInput) {
        fileInput.value = '';
    }
});
```

**Testing:**
1. Upload file, parse entries
2. Change language selector
3. Verify parsed list clears
4. Verify upload section shown
5. Upload file again in new language
6. Verify words match new language

---

### 4. ‚ö†Ô∏è Batch "cycle" No Image (UNDER INVESTIGATION)

**Symptom:** Batch generated "trop" with image ‚úÖ but "cycle" without image ‚ùå  
**User Workaround:** Successfully generated image via edit modal  
**Analysis:**
- Frontend sends `include_images: true` in batch request ‚úÖ
- Backend has comprehensive image generation logging ‚úÖ
- Image skipped if OpenAI doesn't return `image_description` in content
- Backend logs show: "Skipping image generation" with reason

**Possible Causes:**
1. OpenAI content generation didn't return `image_description` for "cycle"
2. Content policy filter blocked image description
3. API error during content generation (caught and continued)

**Investigation Needed:**
- Check backend logs for "cycle" batch generation
- Look for: "‚ö†Ô∏è Skipping image generation for 'cycle'"
- Check APIDebugLog table for image_generation entries

**Status:** Backend has verbose logging to diagnose. Need production logs to identify exact issue.

---

## Version Updates

Updated version number in 3 locations:

1. **frontend/index.html** (line 6):
   ```javascript
   window.APP_VERSION = '2.6.39';
   ```

2. **frontend/index.html** (line 371):
   ```html
   <span class="text-xs">v2.6.39</span>
   ```

3. **frontend/app.js** (line 6):
   ```javascript
   const APP_JS_VERSION = '2.6.39';
   ```

---

## Deployment Steps

1. **Build and Deploy:**
   ```powershell
   .\build-and-deploy.ps1
   ```

2. **Verify Version:**
   - Check version badge shows v2.6.39
   - Check console log shows version match

3. **Test All Fixes:**
   - ‚úÖ manifest.json returns 200 (not 404)
   - ‚úÖ "Generate more cards" works multiple times
   - ‚úÖ Language change clears batch list
   - ‚è≥ Monitor batch image generation

4. **Check Backend Logs:**
   - Look for any "cycle" image generation logs
   - Verify APIDebugLog entries for image_generation

---

## Summary

**Fixed Issues:** 3/4
- ‚úÖ manifest.json 404 errors eliminated
- ‚úÖ Batch import file input resets properly
- ‚úÖ Language change clears batch import
- ‚è≥ Batch image generation needs production log analysis

**Files Modified:**
- `backend/app/main.py` (manifest.json route)
- `frontend/app.js` (file input reset, language change listener, version)
- `frontend/index.html` (version numbers)

**Testing Priority:**
1. Verify manifest.json accessible
2. Test "Generate more cards" workflow
3. Test language change behavior
4. Monitor batch image generation with backend logs

**Next Steps:**
1. Deploy v2.6.39
2. User validates fixes
3. Review backend logs for batch image issue
4. Deploy v2.6.40 if batch image fix needed
